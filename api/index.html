<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecLAB Alpha v5.0 | Enterprise SOC HUD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-deep: #09090b;
            --bg-panel: #18181b;
            --border: #27272a;
            --accent: #3b82f6;
            /* Enterprise Blue */
            --danger: #ef4444;
            --success: #10b981;
            --text-muted: #71717a;
            --text-main: #e4e4e7;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            letter-spacing: -0.01em;
        }

        .mono {
            font-family: 'IBM Plex Mono', monospace;
        }

        .glass {
            background: #18181b;
            /* Solid for Enterprise */
            border: 1px solid var(--border);
        }

        .sidebar-active {
            background: var(--bg-deep);
            border-left: 4px solid var(--accent);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .custom-active-bg {
            background: linear-gradient(to right, rgba(59, 130, 246, 0.1), transparent);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .enterprise-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            /* Standard Enterprise radius */
        }

        .metric-value {
            font-weight: 800;
            letter-spacing: -0.05em;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .pulse-slow {
            animation: pulse-slow 3s infinite;
        }

        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Tactical Overlays */
        .tactical-border {
            position: relative;
        }

        .tactical-border::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 4px;
            border-top: 2px solid var(--accent);
            border-left: 2px solid var(--accent);
        }

        .tactical-border::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 4px;
            height: 4px;
            border-bottom: 2px solid var(--accent);
            border-right: 2px solid var(--accent);
        }
    </style>
</head>

<body class="overflow-hidden select-none">

    <!-- OVERLAYS -->
    <div id="conn-lost"
        class="fixed inset-0 z-[200] bg-zinc-950/95 backdrop-blur-xl hidden flex flex-col items-center justify-center p-12 text-center">
        <div
            class="w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center border border-red-500/30 mb-8 node-pulse">
            <i data-lucide="wifi-off" class="text-red-500 w-10 h-10"></i>
        </div>
        <h2 class="text-3xl font-bold text-white mb-3 uppercase tracking-tighter">Connection Interrupted</h2>
        <p class="text-zinc-500 max-w-sm text-lg">Re-establishing autonomous link with SecLAB Core Central...</p>
        <button onclick="window.location.reload()"
            class="mt-10 px-8 py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-xl font-bold transition">Manual
            Override</button>
    </div>

    <!-- MAIN HUD -->
    <div class="flex h-screen w-full relative">

        <!-- SIDENAV -->
        <aside class="w-64 glass border-r border-white/5 flex flex-col z-50">
            <div class="p-6 border-b border-white/5 bg-zinc-900/50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="shield" class="text-white w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-white font-extrabold text-lg tracking-tight">SecLAB <span
                                class="text-blue-500">Core</span></h1>
                        <p class="text-[8px] font-bold text-zinc-500 uppercase tracking-widest">Enterprise Security Hub
                        </p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 py-8 custom-scroll overflow-y-auto">
                <p class="px-8 text-[10px] font-bold text-zinc-700 uppercase tracking-[0.3em] mb-4">Command Hub</p>
                <button onclick="switchTab('dashboard')" id="nav-dashboard"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group sidebar-active">
                    <i data-lucide="layout" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">Dashboard</span>
                </button>
                <button onclick="switchTab('vulnerabilities')" id="nav-vulnerabilities"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group">
                    <i data-lucide="database" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">Vulnerability Bank</span>
                </button>
                <button onclick="switchTab('patch-lab')" id="nav-patch-lab"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group">
                    <i data-lucide="wand-2" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">AI Remediation</span>
                </button>

                <p class="px-8 text-[10px] font-bold text-zinc-700 uppercase tracking-[0.3em] mt-10 mb-4">Deep Logic</p>
                <button onclick="switchTab('risk')" id="nav-risk"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group">
                    <i data-lucide="target" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">Risk Assessment</span>
                </button>
                <button onclick="switchTab('logic')" id="nav-logic"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group">
                    <i data-lucide="webhook" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">Decision Trees</span>
                </button>
                <button onclick="switchTab('forensics')" id="nav-forensics"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group">
                    <i data-lucide="glasses" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">Code Forensics</span>
                </button>

                <p class="px-8 text-[10px] font-bold text-zinc-700 uppercase tracking-[0.3em] mt-10 mb-4">Governance</p>
                <button onclick="switchTab('reports')" id="nav-reports"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group">
                    <i data-lucide="file-check" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">Compliance Logs</span>
                </button>
                <button onclick="switchTab('network')" id="nav-network"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group">
                    <i data-lucide="shield-alert" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">Infra Monitor</span>
                </button>
                <button onclick="switchTab('engine')" id="nav-engine"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group">
                    <i data-lucide="cpu" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">System Core</span>
                </button>
                <button onclick="switchTab('audit')" id="nav-audit"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group">
                    <i data-lucide="book-open" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">Compliance Ledger</span>
                </button>
                <button onclick="switchTab('audit-stream')" id="nav-audit-stream"
                    class="nav-btn w-full flex items-center gap-4 px-8 py-3.5 hover:bg-white/5 transition group">
                    <i data-lucide="terminal" class="w-4 h-4 group-hover:text-sky-500"></i> <span
                        class="font-bold text-sm">Audit Stream</span>
                </button>
            </nav>

            <div class="p-6">
                <div class="p-5 bg-zinc-900 rounded-2xl border border-white/5 relative group overflow-hidden">
                    <div class="absolute inset-0 shimmer opacity-30 pointer-events-none"></div>
                    <div class="flex items-center gap-3 mb-3 relative z-10">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span class="text-[10px] font-black text-white uppercase tracking-widest">Core Status:
                            Stable</span>
                    </div>
                    <div class="flex justify-between items-center text-[9px] font-mono text-zinc-600 relative z-10">
                        <span id="uptime-clock">00:00:00</span>
                        <span>v5.0-SOC</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN VIEWPORT -->
        <main class="flex-1 flex flex-col min-w-0">

            <!-- TOOLBAR -->
            <header
                class="h-16 glass border-b border-white/5 flex items-center justify-between px-8 relative z-40 bg-zinc-900/50">
                <div class="flex items-center gap-4">
                    <div class="w-1 h-5 bg-blue-500 rounded-full"></div>
                    <div>
                        <h2 id="tab-label" class="text-sm font-bold text-white tracking-widest uppercase">
                            Operational_Alerts</h2>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div id="retry-badge"
                        class="hidden flex items-center gap-2 px-4 py-1.5 bg-red-500/10 border border-red-500/20 rounded-full">
                        <span class="w-1.5 h-1.5 bg-red-500 rounded-full animate-ping"></span>
                        <span class="text-[9px] font-black text-red-500 uppercase">Signal Loss...</span>
                    </div>
                    <button onclick="triggerScan()"
                        class="group relative px-6 py-2.5 bg-sky-600 hover:bg-sky-500 text-white rounded-xl overflow-hidden transition-all shadow-lg active:scale-95">
                        <div class="flex items-center gap-2 relative z-10">
                            <i data-lucide="zap" class="w-4 h-4"></i>
                            <span class="text-[10px] font-black uppercase tracking-widest">Execute Scan</span>
                        </div>
                    </button>
                    <div
                        class="w-10 h-10 rounded-xl bg-zinc-900 border border-white/10 flex items-center justify-center cursor-pointer hover:bg-zinc-800 transition">
                        <i data-lucide="bell" class="w-4 h-4 text-zinc-500"></i>
                    </div>
                </div>
            </header>

            <!-- TAB VIEWS -->
            <div class="flex-1 overflow-y-auto p-12 custom-scroll relative bg-zinc-950/40">

                <!-- 1. DASHBOARD -->
                <section id="tab-dashboard" class="tab-content active space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div
                            class="lg:col-span-2 p-8 enterprise-card flex items-center gap-10 relative overflow-hidden">
                            <div class="absolute -right-10 -bottom-10 opacity-5 pointer-events-none">
                                <i data-lucide="shield" class="w-64 h-64 text-white"></i>
                            </div>
                            <div
                                class="shrink-0 w-32 h-32 rounded-full border-8 border-zinc-900 flex items-center justify-center relative bg-zinc-950">
                                <span class="text-3xl font-bold text-white metric-value" id="dash-health">--</span>
                                <svg class="absolute inset-0 -rotate-90 w-32 h-32">
                                    <circle cx="64" cy="64" r="56" fill="transparent" stroke="currentColor"
                                        stroke-width="8" class="text-zinc-800"></circle>
                                    <circle id="health-ring" cx="64" cy="64" r="56" fill="transparent"
                                        stroke="currentColor" stroke-width="8" stroke-dasharray="351"
                                        stroke-dashoffset="351" class="text-blue-500 transition-all duration-1000">
                                    </circle>
                                </svg>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-1">Security
                                    Health Index</p>
                                <h3 class="text-white text-2xl font-bold tracking-tight mb-3">Executive Oversight</h3>
                                <p class="text-zinc-500 text-xs leading-relaxed max-w-sm">Real-time posture analysis
                                    based on active threat vectors and autonomous remediation efficiency.</p>
                            </div>
                        </div>
                        <div class="p-8 enterprise-card flex flex-col justify-center">
                            <div class="flex justify-between items-start mb-4">
                                <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Active Threats
                                </p>
                                <i data-lucide="alert-triangle" class="w-4 h-4 text-red-500"></i>
                            </div>
                            <h2 class="text-5xl font-extrabold text-white metric-value" id="dash-active">--</h2>
                            <div class="mt-4">
                                <span
                                    class="px-2 py-1 bg-red-500/10 text-red-500 text-[9px] font-bold rounded uppercase">Unresolved</span>
                            </div>
                        </div>
                        <div class="p-8 enterprise-card flex flex-col justify-center border-l-4 border-l-blue-500">
                            <div class="flex justify-between items-start mb-4">
                                <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Auto-Healed</p>
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500"></i>
                            </div>
                            <h2 class="text-5xl font-extrabold text-white metric-value" id="dash-healed">--</h2>
                            <div class="mt-4">
                                <span
                                    class="px-2 py-1 bg-emerald-500/10 text-emerald-500 text-[9px] font-bold rounded uppercase">AI
                                    Success</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="p-8 enterprise-card flex flex-col justify-center">
                            <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-4">Total Detected
                            </p>
                            <h2 class="text-4xl font-extrabold text-white metric-value" id="dash-total">--</h2>
                            <p class="text-[9px] text-zinc-600 mt-2 font-bold uppercase">Total Historical Events</p>
                        </div>
                        <div class="p-8 enterprise-card flex flex-col justify-center">
                            <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-4">Mean Time To
                                Repair</p>
                            <h2 class="text-4xl font-extrabold text-white metric-value" id="dash-mttr">--s</h2>
                            <p class="text-[9px] text-zinc-600 mt-2 font-bold uppercase">AI Resolution Speed</p>
                        </div>
                        <div class="lg:col-span-2 p-8 enterprise-card">
                            <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-6">Risk
                                Distribution</p>
                            <div id="risk-distribution-hud" class="flex gap-4 h-24">
                                <!-- Dynamic Risk Bars -->
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 p-8 enterprise-card h-[400px] flex flex-col">
                            <div class="flex justify-between items-center mb-10">
                                <h4 class="text-white font-bold text-[10px] uppercase tracking-widest opacity-70">Attack
                                    Surface Coverage</h4>
                                <div class="flex items-center gap-2 text-[9px] font-mono text-zinc-600 uppercase">
                                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> Live Telemetry
                                </div>
                            </div>
                            <div class="flex-1 min-h-0 relative">
                                <canvas id="mainFlowChart"></canvas>
                            </div>
                        </div>
                        <div class="p-8 enterprise-card h-[400px] flex flex-col border-t-2 border-t-red-900/40">
                            <h4 class="text-white font-bold text-[10px] uppercase tracking-widest mb-10 opacity-70">
                                Real-Time Event Pulse</h4>
                            <div id="activity-log" class="flex-1 overflow-y-auto custom-scroll space-y-4 pr-2">
                                <!-- Dynamic Logs -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 2. VULNERABILITIES -->
                <section id="tab-vulnerabilities" class="tab-content space-y-8">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-white text-2xl font-bold tracking-tight uppercase">Vulnerability Signature
                                Bank</h3>
                            <p class="text-zinc-500 text-[10px] uppercase tracking-widest font-bold mt-1">Authorized
                                Database of Systemic Risks</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="relative">
                                <i data-lucide="search"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-zinc-600"></i>
                                <input type="text" placeholder="Grep metadata..."
                                    class="bg-zinc-900 border border-white/5 pl-10 pr-6 py-2.5 rounded-lg text-[11px] text-white focus:outline-none focus:border-blue-500/40 transition-all w-80 font-medium">
                            </div>
                            <button
                                class="bg-zinc-800 hover:bg-zinc-700 text-white px-5 py-2.5 rounded-lg text-[10px] font-bold uppercase transition border border-white/5">Export
                                CSV</button>
                        </div>
                    </div>
                    <div class="enterprise-card overflow-hidden">
                        <table class="w-full text-left">
                            <thead
                                class="bg-zinc-900 text-[9px] font-bold text-blue-500 uppercase tracking-widest border-b border-white/5">
                                <tr>
                                    <th class="px-8 py-5">Vulnerability Signature</th>
                                    <th class="px-8 py-5">Source Context</th>
                                    <th class="px-8 py-5 text-center">Severity</th>
                                    <th class="px-8 py-5 text-center">Status</th>
                                    <th class="px-8 py-5 text-right">Laboratory Link</th>
                                </tr>
                            </thead>
                            <tbody id="vuln-table-body"
                                class="divide-y divide-white/5 text-[12px] font-medium text-zinc-400">
                                <!-- Inventory Items -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- 3. VULNERABILITY INVESTIGATION INTERFACE -->
                <section id="tab-patch-lab" class="tab-content h-[calc(100vh-280px)]">
                    <div class="grid grid-cols-12 gap-8 h-full">
                        <!-- 1. Investigation Queue -->
                        <div class="col-span-12 lg:col-span-3 enterprise-card p-6 flex flex-col overflow-hidden">
                            <h4
                                class="text-white font-bold text-[10px] uppercase tracking-widest mb-8 opacity-70 px-2 border-l-2 border-blue-500 pl-4">
                                Investigation Queue</h4>
                            <div id="lab-vuln-list" class="flex-1 overflow-y-auto space-y-4 pr-3 custom-scroll">
                                <!-- Dynamic Vuln Cards -->
                            </div>
                        </div>

                        <!-- 2. Source Code / Diff Core -->
                        <div
                            class="col-span-12 lg:col-span-6 bg-zinc-950 rounded-xl border border-white/5 flex flex-col overflow-hidden relative shadow-2xl">
                            <!-- Header / Controls -->
                            <div
                                class="h-16 border-b border-white/5 flex items-center justify-between px-8 bg-zinc-900/50">
                                <div class="flex items-center gap-6">
                                    <div class="flex gap-1.5">
                                        <div class="w-2.5 h-2.5 rounded-full bg-red-500/20 border border-red-500/50">
                                        </div>
                                        <div
                                            class="w-2.5 h-2.5 rounded-full bg-amber-500/20 border border-amber-500/50">
                                        </div>
                                        <div
                                            class="w-2.5 h-2.5 rounded-full bg-emerald-500/20 border border-emerald-500/50">
                                        </div>
                                    </div>
                                    <div>
                                        <span id="editor-filename"
                                            class="text-[11px] font-mono text-zinc-400 font-bold tracking-tight">investigating_source_artifact...</span>
                                        <div class="text-[9px] text-zinc-600 font-bold uppercase tracking-widest mt-1">
                                            Telemetry Status: Analysis_Active</div>
                                    </div>
                                </div>
                                <div class="flex bg-zinc-950 p-1.5 rounded-2xl border border-white/5">
                                    <button id="view-mode-original" onclick="setViewMode('original')"
                                        class="px-5 py-2 text-[9px] font-black uppercase rounded-xl bg-zinc-800 text-white transition-all shadow-lg active:scale-95">Source</button>
                                    <button id="view-mode-fixed" onclick="setViewMode('fixed')"
                                        class="px-5 py-2 text-[9px] font-black uppercase rounded-xl text-zinc-600 hover:text-zinc-400 transition-all active:scale-95">AI
                                        Fix Preview</button>
                                </div>
                            </div>

                            <!-- Viewer -->
                            <div class="flex-1 flex overflow-hidden bg-zinc-950/50">
                                <div id="editor-nums"
                                    class="w-16 bg-zinc-900/40 text-zinc-700 text-right pr-6 py-10 mono text-[11px] border-r border-white/5 select-none font-bold">
                                </div>
                                <div id="editor-body"
                                    class="flex-1 overflow-auto mono text-[12px] p-10 leading-relaxed relative whitespace-pre text-zinc-500 italic">
                                    <div
                                        class="absolute inset-0 flex flex-col items-center justify-center opacity-10 pointer-events-none">
                                        <i data-lucide="scan-face" class="w-24 h-24 mb-6"></i>
                                        <span class="font-black tracking-[1.5em] uppercase text-xs">Waiting for
                                            Payload</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Resolution Actions -->
                            <div class="p-8 border-t border-white/5 flex gap-4 bg-zinc-900/50">
                                <button onclick="approveNeuralPatch()" id="btn-approve"
                                    class="flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all shadow-xl active:scale-95 flex items-center justify-center gap-3">
                                    <i data-lucide="shield-check" class="w-4 h-4 text-blue-100"></i>
                                    Commit Integrity Fix
                                </button>
                                <button onclick="rejectNeuralPatch()" id="btn-reject"
                                    class="px-8 py-4 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all active:scale-95 border border-white/5">
                                    Bypass
                                </button>
                            </div>
                        </div>

                        <!-- 3. AI Analysis & Guidance -->
                        <div class="col-span-12 lg:col-span-3 space-y-8 overflow-y-auto custom-scroll pr-2">
                            <div class="p-8 enterprise-card space-y-6">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center border border-blue-500/20">
                                        <i data-lucide="brain" class="w-4 h-4 text-blue-500"></i>
                                    </div>
                                    <h5 class="text-white font-bold text-[10px] uppercase tracking-widest opacity-70">
                                        AI Logic Trace</h5>
                                </div>
                                <p id="patch-explanation"
                                    class="text-[11px] text-zinc-400 leading-relaxed border-l-2 border-zinc-700 pl-4">
                                    Initialize investigation to see AI logic...</p>
                            </div>

                            <div class="p-8 bg-emerald-500/5 rounded-xl border border-emerald-500/10 space-y-6">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20">
                                        <i data-lucide="shield" class="w-4 h-4 text-emerald-500"></i>
                                    </div>
                                    <h5
                                        class="text-emerald-500 font-bold text-[10px] uppercase tracking-widest opacity-80">
                                        Resolution Guidance</h5>
                                </div>
                                <p id="patch-guidance"
                                    class="text-[11px] text-zinc-500 leading-relaxed font-bold uppercase tracking-tight">
                                    Security protocols will appear here.</p>
                            </div>

                            <div class="p-6 bg-zinc-950/80 rounded-xl border border-white/5">
                                <h6 class="text-zinc-600 font-bold text-[9px] uppercase tracking-widest mb-3">Forensic
                                    Integrity Score</h6>
                                <div class="flex items-end gap-2">
                                    <span id="patch-risk-score"
                                        class="text-3xl font-extrabold text-white metric-value">0.0</span>
                                    <span class="text-[9px] font-bold text-zinc-700 uppercase mb-1">/ 10.0 Risk</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 4.1 AI DECISION TRANSPARENCY MODULE -->
                <section id="tab-logic" class="tab-content h-[calc(100vh-280px)]">
                    <div class="grid grid-cols-12 gap-8 h-full">
                        <!-- Left: Decision Flow (The "How") -->
                        <div class="col-span-12 lg:col-span-4 flex flex-col gap-6">
                            <div class="p-8 enterprise-card flex flex-col gap-8">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center border border-blue-500/20">
                                        <i data-lucide="brain-circuit" class="w-5 h-5 text-blue-500"></i>
                                    </div>
                                    <h4 class="text-white font-bold text-[11px] uppercase tracking-widest">
                                        Neural Reasoning Path</h4>
                                </div>
                                <div id="logic-steps-flow" class="space-y-1 relative">
                                    <!-- Dynamic Flow Steps -->
                                    <div
                                        class="absolute left-6 top-8 bottom-8 w-0.5 bg-zinc-800 border-l border-white/5">
                                    </div>
                                    <div class="logic-step relative z-10 flex gap-6 pb-10 opacity-30 transition-all duration-500"
                                        id="step-detection">
                                        <div
                                            class="w-12 h-12 rounded-full bg-zinc-950 border-4 border-zinc-800 flex items-center justify-center shrink-0">
                                            <i data-lucide="radar" class="w-4 h-4 text-zinc-600"></i>
                                        </div>
                                        <div>
                                            <h5
                                                class="text-zinc-400 font-black text-[11px] uppercase tracking-widest mb-1">
                                                Detected</h5>
                                            <p class="text-[9px] text-zinc-600 font-bold uppercase">Anomaly
                                                Identification</p>
                                        </div>
                                    </div>
                                    <div class="logic-step relative z-10 flex gap-6 pb-10 opacity-30 transition-all duration-500"
                                        id="step-recognition">
                                        <div
                                            class="w-12 h-12 rounded-full bg-zinc-950 border-4 border-zinc-800 flex items-center justify-center shrink-0">
                                            <i data-lucide="wand-2" class="w-4 h-4 text-zinc-600"></i>
                                        </div>
                                        <div>
                                            <h5
                                                class="text-zinc-400 font-black text-[11px] uppercase tracking-widest mb-1">
                                                Fix Generated</h5>
                                            <p class="text-[9px] text-zinc-600 font-bold uppercase">AI Synthesis
                                            </p>
                                        </div>
                                    </div>
                                    <div class="logic-step relative z-10 flex gap-6 pb-10 opacity-30 transition-all duration-500"
                                        id="step-selection">
                                        <div
                                            class="w-12 h-12 rounded-full bg-zinc-950 border-4 border-zinc-800 flex items-center justify-center shrink-0">
                                            <i data-lucide="shield-check" class="w-4 h-4 text-zinc-600"></i>
                                        </div>
                                        <div>
                                            <h5
                                                class="text-zinc-400 font-black text-[11px] uppercase tracking-widest mb-1">
                                                Validated</h5>
                                            <p class="text-[9px] text-zinc-600 font-bold uppercase">Integrity Verified
                                            </p>
                                        </div>
                                    </div>
                                    <div class="logic-step relative z-10 flex gap-6 pb-10 opacity-30 transition-all duration-500"
                                        id="step-approval">
                                        <div
                                            class="w-12 h-12 rounded-full bg-zinc-950 border-4 border-zinc-800 flex items-center justify-center shrink-0">
                                            <i data-lucide="check-circle" class="w-4 h-4 text-zinc-600"></i>
                                        </div>
                                        <div>
                                            <h5
                                                class="text-zinc-400 font-black text-[11px] uppercase tracking-widest mb-1">
                                                Approved</h5>
                                            <p class="text-[9px] text-zinc-600 font-bold uppercase">Governance
                                                Compliance
                                            </p>
                                        </div>
                                    </div>
                                    <div class="logic-step relative z-10 flex gap-6 opacity-30 transition-all duration-500"
                                        id="step-closed">
                                        <div
                                            class="w-12 h-12 rounded-full bg-zinc-950 border-4 border-zinc-800 flex items-center justify-center shrink-0">
                                            <i data-lucide="lock" class="w-4 h-4 text-zinc-600"></i>
                                        </div>
                                        <div>
                                            <h5
                                                class="text-zinc-400 font-black text-[11px] uppercase tracking-widest mb-1">
                                                Closed</h5>
                                            <p class="text-[9px] text-zinc-600 font-bold uppercase">Issue Resolved
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Detailed Reasoning Terminal (The "Why") -->
                        <div
                            class="col-span-12 lg:col-span-8 bg-zinc-950 rounded-[3rem] border border-white/5 overflow-hidden flex flex-col shadow-2xl relative">
                            <div
                                class="h-16 border-b border-white/5 flex items-center justify-between px-10 bg-black/40">
                                <div class="flex items-center gap-4">
                                    <div class="flex gap-1.5">
                                        <div class="w-2.5 h-2.5 rounded-full bg-red-500/20"></div>
                                        <div class="w-2.5 h-2.5 rounded-full bg-amber-500/20"></div>
                                        <div class="w-2.5 h-2.5 rounded-full bg-emerald-500/20"></div>
                                    </div>
                                    <h5 class="text-zinc-500 font-black text-[9px] uppercase tracking-[0.3em] ml-4">
                                        Transparency_Console.v5</h5>
                                </div>
                                <div id="logic-conf-badge"
                                    class="px-3 py-1 bg-sky-500/10 border border-sky-500/20 rounded-full text-[9px] font-black text-sky-500 uppercase tracking-widest opacity-0 transition-opacity">
                                    CONFIDENCE: 92%</div>
                            </div>
                            <div id="logic-reasoning-terminal"
                                class="flex-1 p-10 font-mono text-[12px] leading-loose text-zinc-500 overflow-auto custom-scroll">
                                <div class="flex gap-4 opacity-50 italic">[SYSTEM] Initializing decision audit module...
                                </div>
                                <div class="flex gap-4 opacity-50 italic">[SYSTEM] Awaiting neural trace data source...
                                </div>
                            </div>
                            <div class="p-8 bg-zinc-900/30 border-t border-white/5">
                                <p
                                    class="text-[10px] text-zinc-600 font-bold uppercase tracking-widest flex items-center gap-3 italic">
                                    <i data-lucide="info" class="w-3 h-3"></i>
                                    Note: This interface is for audit and validation purposes only. Direct modification
                                    of AI reasoning is restricted to maintain chain-of-custody.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 4. RISK ASSESSMENT ENGINE -->
                <section id="tab-risk"
                    class="tab-content space-y-10 h-[calc(100vh-280px)] overflow-y-auto custom-scroll pr-4">
                    <div class="grid grid-cols-12 gap-8">
                        <!-- High Level Risk Score -->
                        <div
                            class="col-span-12 lg:col-span-4 p-8 enterprise-card flex flex-col items-center justify-center text-center relative overflow-hidden h-[400px]">
                            <div class="relative w-40 h-40 flex items-center justify-center mb-8">
                                <svg class="w-full h-full -rotate-90">
                                    <circle cx="80" cy="80" r="72" stroke="currentColor" stroke-width="4"
                                        fill="transparent" class="text-zinc-800" />
                                    <circle id="risk-gauge-circle" cx="80" cy="80" r="72" stroke="currentColor"
                                        stroke-width="10" fill="transparent" stroke-dasharray="452"
                                        stroke-dashoffset="452"
                                        class="text-blue-500 transition-all duration-1000 ease-out" />
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span id="risk-engine-score"
                                        class="text-5xl font-extrabold text-white metric-value">0.0</span>
                                    <span
                                        class="text-[9px] font-bold text-zinc-600 uppercase tracking-widest mt-1">DANGER_INDEX</span>
                                </div>
                            </div>
                            <h4 id="risk-impact-classification"
                                class="text-lg font-bold text-white tracking-widest uppercase border-b-2 border-blue-500/40 pb-2">
                                AWAITING_INPUT</h4>
                        </div>

                        <!-- Multi-Vector Analysis -->
                        <div
                            class="col-span-12 lg:col-span-8 p-8 bg-zinc-950 rounded-xl border border-white/5 space-y-10 h-[400px] flex flex-col">
                            <div class="flex justify-between items-center">
                                <h4 class="text-white font-bold uppercase tracking-widest text-[10px] opacity-70">
                                    Normalized Risk Vectors</h4>
                                <div
                                    class="px-3 py-1 bg-blue-500/10 border border-blue-500/20 rounded-md text-[8px] font-bold text-blue-500 uppercase">
                                    Heuristic v5.0</div>
                            </div>
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 flex-1">
                                <div
                                    class="p-6 enterprise-card flex flex-col justify-between group hover:border-red-500/30 transition duration-500">
                                    <span
                                        class="text-[9px] font-bold text-zinc-600 uppercase tracking-widest">Severity</span>
                                    <h5 id="risk-v-sev" class="text-xl font-bold text-white metric-value">--</h5>
                                    <div class="w-full h-1 bg-zinc-800 rounded-full overflow-hidden">
                                        <div id="risk-b-sev" class="h-full bg-red-500 transition-all duration-1000"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                                <div
                                    class="p-6 enterprise-card flex flex-col justify-between group hover:border-amber-500/30 transition duration-500">
                                    <span
                                        class="text-[9px] font-bold text-zinc-600 uppercase tracking-widest">Exploitability</span>
                                    <h5 id="risk-v-expl" class="text-xl font-bold text-white metric-value">--</h5>
                                    <div class="w-full h-1 bg-zinc-800 rounded-full overflow-hidden">
                                        <div id="risk-b-expl" class="h-full bg-amber-500 transition-all duration-1000"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                                <div
                                    class="p-6 enterprise-card flex flex-col justify-between group hover:border-blue-500/30 transition duration-500">
                                    <span
                                        class="text-[9px] font-bold text-zinc-600 uppercase tracking-widest">Exposure</span>
                                    <h5 id="risk-v-exp" class="text-xl font-bold text-white metric-value">--</h5>
                                    <div class="w-full h-1 bg-zinc-800 rounded-full overflow-hidden">
                                        <div id="risk-b-exp" class="h-full bg-blue-500 transition-all duration-1000"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                                <div
                                    class="p-6 enterprise-card flex flex-col justify-between group hover:border-white/30 transition duration-500">
                                    <span class="text-[9px] font-bold text-zinc-600 uppercase tracking-widest">Asset
                                        Criticality</span>
                                    <h5 id="risk-v-crit" class="text-xl font-bold text-white metric-value">--</h5>
                                    <div class="w-full h-1 bg-zinc-800 rounded-full overflow-hidden">
                                        <div id="risk-b-crit" class="h-full bg-white transition-all duration-1000"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Business Impact Matrix -->
                        <div class="col-span-12 p-12 bg-zinc-900/20 rounded-[3rem] border border-white/5 space-y-8">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-10 h-10 rounded-2xl bg-sky-500/10 flex items-center justify-center border border-sky-500/20">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 text-sky-500"></i>
                                </div>
                                <h4 class="text-white font-black text-[12px] uppercase tracking-widest">Enterprise
                                    Business Impact Projection</h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                                <div class="p-8 bg-zinc-950/50 rounded-[2rem] border border-white/5 space-y-4">
                                    <h6 class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Strategic
                                        Impact</h6>
                                    <p class="text-zinc-400 text-xs leading-relaxed italic">The identified threat
                                        vectors target mission-critical kernels. Exploitation will lead to immediate
                                        degradation of strategic operational capacity and core infrastructure state.</p>
                                </div>
                                <div class="p-8 bg-zinc-950/50 rounded-[2rem] border border-white/5 space-y-4">
                                    <h6 class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">
                                        Compliance Status</h6>
                                    <p class="text-zinc-400 text-xs leading-relaxed italic">Technical signature directly
                                        violates ISO 27001 Access Control and SOC2 Data Integrity mandates. Immediate
                                        remediation required to maintain governance certification.</p>
                                </div>
                                <div class="p-8 bg-zinc-950/50 rounded-[2rem] border border-white/5 space-y-4">
                                    <h6 class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Residual
                                        Risk Target</h6>
                                    <p class="text-zinc-400 text-xs leading-relaxed italic">Projected residual risk
                                        post-patching: <span class="text-emerald-500 font-bold">0.8 Normalized
                                            Score</span>. AI autonomous remediation path verified as optimal resolution.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 5. COMPLIANCE REPORTS -->
                <section id="tab-reports" class="tab-content space-y-8">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-white text-2xl font-bold tracking-tight uppercase">Executive Audit Vault
                            </h3>
                            <p class="text-zinc-500 text-[10px] uppercase tracking-widest font-bold mt-1">ISO 27001 /
                                SOC2 Compliant Artifacts</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="reports-grid">
                        <!-- Dynamic Reports Load -->
                    </div>
                </section>

                <!-- 6. SECURITY INFRASTRUCTURE MONITOR -->
                <section id="tab-network"
                    class="tab-content space-y-12 h-[calc(100vh-280px)] overflow-y-auto custom-scroll pr-4">
                    <!-- Posture Overview -->
                    <div class="grid grid-cols-12 gap-10">
                        <div
                            class="col-span-12 lg:col-span-4 p-8 enterprise-card flex flex-col items-center justify-center text-center relative overflow-hidden h-[400px]">
                            <div class="relative w-40 h-40 flex items-center justify-center mb-8">
                                <svg class="w-full h-full -rotate-90">
                                    <circle cx="80" cy="80" r="72" stroke="currentColor" stroke-width="4"
                                        fill="transparent" class="text-zinc-800" />
                                    <circle id="infra-posture-ring" cx="80" cy="80" r="72" stroke="currentColor"
                                        stroke-width="8" fill="transparent" stroke-dasharray="452"
                                        stroke-dashoffset="452"
                                        class="text-emerald-500 transition-all duration-1000 ease-out" />
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span id="infra-posture-score"
                                        class="text-5xl font-extrabold text-white metric-value">0%</span>
                                    <span
                                        class="text-[9px] font-bold text-zinc-600 uppercase tracking-widest mt-1">Posture_Index</span>
                                </div>
                            </div>
                            <h3
                                class="text-white text-lg font-bold uppercase tracking-widest border-b-2 border-emerald-500/40 pb-2">
                                Infrastructure_Health</h3>
                        </div>

                        <div class="col-span-12 lg:col-span-8 grid grid-cols-1 md:grid-cols-2 gap-10">
                            <div class="p-8 enterprise-card flex flex-col justify-center">
                                <p
                                    class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest mb-6 border-b border-white/5 pb-4">
                                    Scan Coverage</p>
                                <div class="flex items-end gap-3 mb-2">
                                    <h4 id="infra-avg-coverage" class="text-5xl font-extrabold text-white metric-value">
                                        0%</h4>
                                    <span
                                        class="text-emerald-500 font-bold text-[9px] mb-3 uppercase tracking-widest bg-emerald-500/10 px-2 py-0.5 rounded-sm">Optimized</span>
                                </div>
                                <div class="w-full h-1 bg-zinc-800 rounded-full overflow-hidden">
                                    <div id="infra-coverage-bar" class="h-full bg-blue-500 transition-all duration-1000"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="p-8 enterprise-card flex flex-col justify-center">
                                <p
                                    class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest mb-6 border-b border-white/5 pb-4">
                                    Protected Assets</p>
                                <div class="flex items-center gap-8">
                                    <div>
                                        <h4 id="infra-total-assets"
                                            class="text-5xl font-extrabold text-white metric-value">0</h4>
                                        <p class="text-[8px] font-bold text-zinc-600 uppercase mt-2">Active Entities
                                        </p>
                                    </div>
                                    <div class="flex-1 space-y-3">
                                        <div
                                            class="flex justify-between items-center text-[8px] font-bold uppercase tracking-widest">
                                            <span class="text-zinc-600">Production</span>
                                            <span id="infra-env-prod" class="text-white">0</span>
                                        </div>
                                        <div
                                            class="flex justify-between items-center text-[8px] font-bold uppercase tracking-widest">
                                            <span class="text-zinc-600">Staging</span>
                                            <span id="infra-env-stag" class="text-white">0</span>
                                        </div>
                                        <div
                                            class="flex justify-between items-center text-[8px] font-bold uppercase tracking-widest">
                                            <span class="text-zinc-600">Development</span>
                                            <span id="infra-env-dev" class="text-white">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Asset Matrix -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 pb-10" id="infra-asset-grid">
                        <!-- Assets rendered via JS -->
                    </div>
                </section>

                <!-- 7. CODE FORENSICS ANALYSIS MODULE -->
                <section id="tab-forensics" class="tab-content h-[calc(100vh-280px)]">
                    <div class="grid grid-cols-12 gap-8 h-full">
                        <!-- Left: Forensic Diff View -->
                        <div class="col-span-12 lg:col-span-8 flex flex-col gap-8 h-full">
                            <div
                                class="flex-1 bg-zinc-950 rounded-xl border border-white/5 flex flex-col overflow-hidden relative shadow-2xl">
                                <div
                                    class="h-16 border-b border-white/5 flex items-center justify-between px-8 bg-zinc-900/50">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center border border-blue-500/20">
                                            <i data-lucide="diff" class="w-4 h-4 text-blue-500"></i>
                                        </div>
                                        <h5
                                            class="text-white font-bold text-[10px] uppercase tracking-widest opacity-70">
                                            Side-By-Side Forensic Delta</h5>
                                    </div>
                                    <div
                                        class="flex gap-10 text-[9px] font-black uppercase tracking-widest text-zinc-600">
                                        <span class="flex items-center gap-2">
                                            <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> Vulnerable State
                                        </span>
                                        <span class="flex items-center gap-2">
                                            <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div> Remediation
                                            State
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-1 grid grid-cols-2 divide-x divide-white/5 overflow-hidden">
                                    <!-- Original Side -->
                                    <div class="flex flex-col overflow-hidden bg-red-500/[0.02]">
                                        <div
                                            class="p-4 bg-red-500/10 border-b border-red-500/20 text-[9px] font-black text-red-500 uppercase tracking-widest text-center">
                                            Threat Artifact</div>
                                        <div id="forensic-editor-orig"
                                            class="flex-1 overflow-auto mono text-[11px] p-8 leading-relaxed whitespace-pre text-zinc-500 custom-scroll italic">
                                            [AWAITING_ARTIFACT] </div>
                                    </div>
                                    <!-- Fixed Side -->
                                    <div class="flex flex-col overflow-hidden bg-emerald-500/[0.02]">
                                        <div
                                            class="p-4 bg-emerald-500/10 border-b border-emerald-500/20 text-[9px] font-black text-emerald-500 uppercase tracking-widest text-center">
                                            Patched Integrity</div>
                                        <div id="forensic-editor-fixed"
                                            class="flex-1 overflow-auto mono text-[11px] p-8 leading-relaxed whitespace-pre text-zinc-500 custom-scroll italic">
                                            [AWAITING_REMEDIATION] </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Forensic Intelligence -->
                        <div class="col-span-12 lg:col-span-4 h-full flex flex-col gap-8">
                            <!-- Root Cause -->
                            <div class="bg-zinc-900/50 rounded-[2.5rem] border border-white/5 p-8 flex flex-col gap-6">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="w-8 h-8 rounded-xl bg-orange-500/10 flex items-center justify-center border border-orange-500/20">
                                        <i data-lucide="search" class="w-4 h-4 text-orange-500"></i>
                                    </div>
                                    <h4
                                        class="text-white font-black text-[10px] uppercase tracking-widest opacity-50 underline decoration-orange-500/40 decoration-2 underline-offset-8">
                                        Root Cause Analysis</h4>
                                </div>
                                <p id="forensic-root-cause"
                                    class="text-xs text-zinc-400 leading-relaxed font-bold tracking-tight italic">
                                    Analyzing logic sinks...</p>
                            </div>

                            <!-- Exploit Scenario -->
                            <div
                                class="bg-zinc-900/50 rounded-[2.5rem] border border-white/5 p-8 flex flex-col gap-6 flex-1">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="w-8 h-8 rounded-xl bg-red-500/10 flex items-center justify-center border border-red-500/20">
                                        <i data-lucide="skull" class="w-4 h-4 text-red-500"></i>
                                    </div>
                                    <h4
                                        class="text-white font-black text-[10px] uppercase tracking-widest opacity-50 underline decoration-red-500/40 decoration-2 underline-offset-8">
                                        Exploit Scenario</h4>
                                </div>
                                <div class="bg-black/40 p-6 rounded-2xl border border-white/5 space-y-4">
                                    <p id="forensic-exploit"
                                        class="text-xs text-zinc-400 font-mono leading-relaxed uppercase tracking-tighter">
                                        Payload logic analysis pending...</p>
                                </div>
                                <div class="mt-auto pt-6 border-t border-white/5">
                                    <div class="flex justify-between items-center mb-4">
                                        <span class="text-[9px] font-black text-zinc-600 uppercase">Vector
                                            Probability</span>
                                        <span class="text-red-500 font-black text-xs italic">HIGH_THREAT</span>
                                    </div>
                                    <div class="w-full h-1 bg-zinc-800 rounded-full overflow-hidden">
                                        <div class="w-[85%] h-full bg-red-500"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 8. COMPLIANCE LEDGER -->
                <section id="tab-audit" class="tab-content h-[calc(100vh-280px)] overflow-hidden flex flex-col">
                    <div
                        class="p-8 bg-zinc-950 rounded-xl border border-white/5 flex flex-col h-full overflow-hidden shadow-2xl">
                        <div class="flex justify-between items-center mb-8">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20">
                                    <i data-lucide="shield-check" class="w-5 h-5 text-emerald-500"></i>
                                </div>
                                <div>
                                    <h3 class="text-white text-xl font-bold tracking-tight uppercase">
                                        Compliance Ledger</h3>
                                    <p class="text-zinc-600 text-[9px] font-bold tracking-widest uppercase mt-1">
                                        Audit-Ready Immutable Event Stream</p>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="exportComplianceCSV()"
                                    class="px-5 py-2 bg-zinc-900 border border-white/5 rounded-lg text-[9px] font-bold text-white uppercase tracking-widest hover:bg-white/5 transition flex items-center gap-2">
                                    <i data-lucide="download" class="w-3 h-3"></i> Export CSV
                                </button>
                                <div
                                    class="px-5 py-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-[9px] font-bold text-emerald-500 uppercase tracking-widest flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                                    Integrity_Locked
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 overflow-auto custom-scroll">
                            <table class="w-full text-left border-collapse">
                                <thead
                                    class="sticky top-0 bg-zinc-950 text-[10px] font-black text-zinc-500 uppercase tracking-widest border-b border-white/5 z-20">
                                    <tr>
                                        <th class="px-8 py-6">Timestamp / SeqID</th>
                                        <th class="px-8 py-6">Action Type</th>
                                        <th class="px-8 py-6">Description</th>
                                        <th class="px-8 py-6">Actor</th>
                                        <th class="px-8 py-6 text-right">Integrity Hash</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-ledger-body" class="divide-y divide-white/5 text-[11px] text-zinc-400">
                                    <tr>
                                        <td colspan="5"
                                            class="px-8 py-20 text-center italic text-zinc-600 font-mono tracking-widest">
                                            AWAITING_TELEMETRY_STREAM...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 8.1 REAL-TIME SECURITY AUDIT STREAM -->
                <section id="tab-audit-stream" class="tab-content h-[calc(100vh-280px)]">
                    <div
                        class="bg-black/80 rounded-xl border border-white/5 h-full flex flex-col overflow-hidden shadow-2xl relative">
                        <!-- Terminal Header -->
                        <div class="h-12 border-b border-white/5 flex items-center justify-between px-8 bg-zinc-900/50">
                            <div class="flex items-center gap-3">
                                <div class="flex gap-1.5">
                                    <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                    <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                                    <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                </div>
                                <h5 class="text-zinc-500 font-bold text-[9px] uppercase tracking-widest ml-4">
                                    Live_Audit_Log.bin</h5>
                            </div>
                            <div class="flex items-center gap-5">
                                <span class="flex items-center gap-2 text-[8px] font-bold text-blue-500 uppercase">
                                    <span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse"></span>
                                    Stream_Active
                                </span>
                                <span id="audit-stream-count" class="text-[9px] font-mono text-zinc-600 uppercase">EVT:
                                    0</span>
                            </div>
                        </div>

                        <!-- Terminal Body -->
                        <div id="audit-terminal-container"
                            class="flex-1 p-10 font-mono text-[12px] overflow-auto custom-scroll selection:bg-sky-500/30">
                            <div class="opacity-50 italic mb-4">[SYSTEM] Establishing secure link to SOC event bus...
                            </div>
                            <div id="audit-terminal-stream" class="space-y-4">
                                <!-- Events stream here -->
                            </div>
                            <div id="audit-terminal-cursor" class="mt-4 flex gap-2 items-center">
                                <span class="text-sky-500">SOC_OPERATOR@KERNEL:~$</span>
                                <span class="w-2 h-4 bg-sky-500 animate-pulse"></span>
                            </div>
                        </div>

                        <!-- Footer Info -->
                        <div class="p-6 bg-zinc-900/20 border-t border-white/5 flex justify-between items-center">
                            <div class="flex gap-6">
                                <div class="flex items-center gap-2 text-[8px] font-black text-zinc-500 uppercase">
                                    <i data-lucide="shield" class="w-3 h-3"></i> READ_ONLY_MODE
                                </div>
                                <div class="flex items-center gap-2 text-[8px] font-black text-zinc-500 uppercase">
                                    <i data-lucide="hash" class="w-3 h-3"></i> CHAIN_VERIFIED
                                </div>
                            </div>
                            <div class="text-[8px] font-black text-zinc-700 uppercase italic">
                                Total telemetry bandwidth: <span class="text-sky-500">12.4 kb/s</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 9. SYSTEM CORE MONITOR -->
                <section id="tab-engine"
                    class="tab-content space-y-12 h-[calc(100vh-280px)] overflow-y-auto custom-scroll pr-4">
                    <!-- Operational Health HUD -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="p-6 enterprise-card space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest">AI
                                    Engine</span>
                                <span id="health-ai-status"
                                    class="px-2 py-0.5 bg-blue-500/10 text-blue-500 rounded text-[8px] font-bold uppercase">Online</span>
                            </div>
                            <h4 class="text-white font-extrabold text-2xl metric-value">98.2%</h4>
                            <p class="text-[9px] text-zinc-600 font-bold uppercase tracking-widest mt-1">Neural Load
                                Index</p>
                        </div>
                        <div class="p-6 enterprise-card space-y-4">
                            <div class="flex justify-between items-center">
                                <span
                                    class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest">Scanner</span>
                                <span id="health-scanner-status"
                                    class="px-2 py-0.5 bg-emerald-500/10 text-emerald-500 rounded text-[8px] font-bold uppercase">Standby</span>
                            </div>
                            <h4 class="text-white font-extrabold text-2xl metric-value">v4.2.0</h4>
                            <p class="text-[9px] text-zinc-600 font-bold uppercase tracking-widest mt-1">Diagnostic Node
                            </p>
                        </div>
                        <div class="p-6 enterprise-card space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest">Queues</span>
                                <span class="text-zinc-600 text-[8px] font-bold uppercase tracking-widest">Active</span>
                            </div>
                            <h4 id="health-queue-total" class="text-white font-extrabold text-2xl metric-value">0</h4>
                            <p class="text-[9px] text-zinc-600 font-bold uppercase tracking-widest mt-1">Pending State
                                Tasks</p>
                        </div>
                        <div class="p-6 enterprise-card space-y-4 border-l-4 border-l-blue-500">
                            <div class="flex justify-between items-center">
                                <span class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest">Uptime</span>
                                <i data-lucide="clock" class="w-3 h-3 text-blue-500"></i>
                            </div>
                            <h4 id="health-uptime" class="text-white font-extrabold text-xl metric-value">0s</h4>
                            <p class="text-[9px] text-zinc-600 font-bold uppercase tracking-widest mt-1">Continuous
                                Runtime</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-8">
                        <!-- Controls -->
                        <div class="col-span-12 lg:col-span-4 space-y-8">
                            <div class="p-10 bg-zinc-900/50 rounded-[2.5rem] border border-white/5 space-y-8">
                                <h4 class="text-white font-black text-[10px] uppercase tracking-widest opacity-50">
                                    Scanner Configuration</h4>
                                <div class="space-y-4">
                                    <label
                                        class="block text-[10px] font-bold text-zinc-600 uppercase tracking-widest">Target
                                        Path / Source URL</label>
                                    <input type="text" id="scan-target"
                                        placeholder="e.g. ./scan_engine or https://github.com/..."
                                        class="w-full bg-black/50 border border-white/5 px-6 py-4 rounded-2xl text-white text-xs focus:outline-none focus:border-sky-500/40 transition-all font-bold">
                                </div>
                                <div class="space-y-4">
                                    <label
                                        class="block text-[10px] font-bold text-zinc-600 uppercase tracking-widest">Analysis
                                        Depth</label>
                                    <select
                                        class="w-full bg-black/50 border border-white/5 px-6 py-4 rounded-2xl text-white text-xs focus:outline-none focus:border-sky-500/40 transition-all font-bold appearance-none">
                                        <option>HEURISTIC_STATIC</option>
                                        <option disabled>DEEP_NEURAL_TRACE (PRO)</option>
                                    </select>
                                </div>
                                <button onclick="triggerScan()" id="btn-run-scan"
                                    class="w-full py-4 bg-sky-600 hover:bg-sky-500 text-white rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] transition-all shadow-lg shadow-sky-900/20 active:scale-95 flex items-center justify-center gap-3">
                                    <i data-lucide="zap" class="w-4 h-4"></i>
                                    Launch Diagnostic
                                </button>
                            </div>

                            <div class="p-10 bg-zinc-900/30 rounded-[2.5rem] border border-white/5">
                                <h4
                                    class="text-white font-black text-[10px] uppercase tracking-widest mb-6 opacity-30 italic">
                                    Scanner Moto</h4>
                                <p class="text-zinc-500 text-xs leading-relaxed">Controlled vulnerability discovery
                                    across decentralized infrastructure nodes. Every finding is uniquely hashed and
                                    indexed for autonomous remediation.</p>
                            </div>
                        </div>

                        <!-- History -->
                        <div
                            class="col-span-12 lg:col-span-8 bg-zinc-900/50 rounded-[3rem] border border-white/5 overflow-hidden flex flex-col">
                            <div class="p-8 border-b border-white/5 flex justify-between items-center">
                                <h4 class="text-white font-black text-[10px] uppercase tracking-widest opacity-50">Scan
                                    Diagnostic Logs</h4>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                    <span class="text-[9px] font-bold text-zinc-500 uppercase">Core_Ready</span>
                                </div>
                            </div>
                            <div class="flex-1 overflow-auto custom-scroll">
                                <table class="w-full text-left border-collapse">
                                    <thead
                                        class="sticky top-0 bg-zinc-950 text-[9px] font-bold text-sky-500 uppercase tracking-widest border-b border-white/5">
                                        <tr>
                                            <th class="px-8 py-6">ID / Timestamp</th>
                                            <th class="px-8 py-6">Target Origin</th>
                                            <th class="px-8 py-6 text-center">Status</th>
                                            <th class="px-8 py-6 text-right">Findings</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scan-history-body"
                                        class="divide-y divide-white/5 text-[11px] text-zinc-400">
                                        <tr>
                                            <td colspan="4" class="px-8 py-20 text-center italic text-zinc-600">Awaiting
                                                diagnostic initialization...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

            </div>

            <!-- FOOTER -->
            <footer class="h-14 glass border-t border-white/5 px-10 flex items-center justify-between relative z-[100]">
                <div class="flex items-center gap-10 overflow-hidden flex-1">
                    <span class="text-blue-500 font-bold uppercase text-[10px] tracking-widest shrink-0">System
                        Feed :</span>
                    <div class="marquee-container flex-1 overflow-hidden whitespace-nowrap">
                        <div id="footer-marquee"
                            class="inline-block text-[10px] font-bold text-zinc-700 uppercase tracking-[0.2em]">
                            [CORE_INIT_OK] - [NODE_SYNC: 100%] - [DATABASE_PERSISTENCE: ENGAGED] - [AI_LINK: ACTIVE] -
                            [SENTINEL_MODE: ARMED]
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-6 ml-10 shrink-0 text-zinc-700 font-bold text-[10px] tracking-widest">
                    <span id="real-clock">00:00:00</span>
                    <i data-lucide="radio" class="w-4 h-4"></i>
                </div>
            </footer>

        </main>
    </div>

    <!-- NOTIFICATIONS -->
    <div id="toast-container" class="fixed top-24 right-10 z-[1000] w-96 space-y-4 pointer-events-none"></div>

    <script>
        // --- GLOBAL STATE ---
        let mainStatsChart = null;

        // --- APP INITIALIZER ---
        window.addEventListener('load', async () => {
            lucide.createIcons();
            initCharts();
            startMainHeartbeat();

            // Health UI Startup
            updateHealthCircle(0);

            // Initial Sync
            await syncAllData();

            // Continuous Clock
            setInterval(() => {
                const clock = document.getElementById('real-clock');
                const uptime = document.getElementById('uptime-clock');
                if (clock) clock.innerText = new Date().toLocaleTimeString('en-GB');
                if (uptime) uptime.innerText = new Date().toLocaleTimeString();
            }, 1000);
        });

        function initCharts() {
            const ctxEl = document.getElementById('mainFlowChart');
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            mainStatsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['-6h', '-5h', '-4h', '-3h', '-2h', '-1h', 'NOW'],
                    datasets: [{
                        label: 'Threat Intensity',
                        data: [5, 12, 8, 45, 22, 60, 35],
                        borderColor: '#3b82f6',
                        borderWidth: 3,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: (context) => {
                            const g = context.chart.ctx.createLinearGradient(0, 0, 0, 300);
                            g.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                            g.addColorStop(1, 'transparent');
                            return g;
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.02)' }, ticks: { color: '#3f3f46', font: { size: 9, weight: 'bold' } } },
                        x: { grid: { display: false }, ticks: { color: '#3f3f46', font: { size: 9, weight: 'bold' } } }
                    }
                }
            });
        }

        // --- NAVIGATION ENGINE ---
        function switchTab(id) {
            updateState({ activeTabId: id });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const target = document.getElementById('tab-' + id);
            if (target) target.classList.add('active');

            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('sidebar-active'));
            const navBtn = document.getElementById('nav-' + id);
            if (navBtn) navBtn.classList.add('sidebar-active');

            const tabTitles = {
                dashboard: 'Sentinel_Dashboard', vulnerabilities: 'Signature_Repo', 'patch-lab': 'AI_Neural_Studio',
                risk: 'Crisis_Assessment', logic: 'Decision_Matrix', forensics: 'Code_Forensics',
                reports: 'Compliance_Vault', network: 'Infra_Monitor', engine: 'System_Core_Monitor',
                audit: 'Compliance_Ledger', 'audit-stream': 'Audit_Terminal'
            };
            const label = document.getElementById('tab-label');
            if (label) label.innerText = (tabTitles[id] || id).toUpperCase();
        }

        // --- PIPELINE CONTROLLER (RE-ARCHITECTED) ---

        const STAGES = {
            DETECTED: 'DETECTED',
            FIX_GENERATED: 'FIX_GENERATED',
            VALIDATED: 'VALIDATED',
            APPROVED: 'APPROVED',
            CLOSED: 'CLOSED'
        };

        const PipelineStore = {
            state: {
                scanId: null,
                files: [],
                vulnerabilities: [],
                activeVulnerability: null,
                generatedPatches: [], // { vulnId, code, explanation }
                validationResults: [], // { vulnId, status, score }
                lifecycleLog: [],
                systemMetrics: {
                    totalScans: 0,
                    totalVulnerabilities: 0,
                    autoFixed: 0,
                    pending: 0,
                    riskScore: 0
                },
                activeTabId: 'dashboard'
            },

            listeners: [],

            subscribe(fn) {
                this.listeners.push(fn);
            },

            update(partialState) {
                this.state = { ...this.state, ...partialState };
                this.notify();
            },

            notify() {
                this.listeners.forEach(fn => fn(this.state));
                // Legacy Bridge: Trigger UI updates based on active tab
                renderApp();
            }
        };

        // Output for console debugging
        window.pipelineState = PipelineStore.state;

        // --- COMPATIBILITY BRIDGE ---
        // Mapping old calls to new Store
        function updateState(updates) {
            PipelineStore.update(updates);
        }

        function renderApp() {
            const state = PipelineStore.state;
            const tid = state.activeTabId;

            // Global Updates
            renderDashboardMetrics();
            updateSystemMarquee();

            // Tab Specific Updates
            if (tid === 'vulnerabilities') renderVulnerabilityBank();
            if (tid === 'patch-lab') renderPatchLaboratory();
            if (tid === 'audit') renderComplianceLedger();
            if (tid === 'audit-stream') renderAuditStream();
            if (tid === 'risk') renderRiskAssessment(); // Renamed from updateRiskUI
            if (tid === 'logic') updateLogicUI();
            if (tid === 'forensics') updateForensisView();
            // Network & Engine are polling based, mostly independent but can read state
        }

        /**
         * Lifecycle Logger with Integrity Hashing
         */
        async function logLifecycleEvent(action, targetId, description) {
            const timestamp = new Date().toISOString();
            const raw = `${timestamp}|${action}|${targetId}|${description}`;

            // SHA256 Integrity
            const msgUint8 = new TextEncoder().encode(raw);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            const event = {
                timestamp,
                vulnerabilityId: targetId,
                action: action,
                actor: "AI_ENGINE",
                integrityHash: hashHex,
                description // Keep for UI display
            };

            const currentLog = PipelineStore.state.lifecycleLog;
            PipelineStore.update({ lifecycleLog: [...currentLog, event] });

            // Toast
            sendHUDToast(`LOGGED: ${action}`, "info");
        }

        // Alias for compatibility if needed
        const addLifecycleEvent = logLifecycleEvent;

        async function syncAllData() {
            try {
                const state = PipelineStore.state;

                // 1. Fetch Dashboard Metrics
                const dashRes = await fetch('/dashboard');
                if (dashRes.ok) {
                    const data = await dashRes.json();
                    PipelineStore.update({
                        systemMetrics: {
                            ...state.systemMetrics,
                            riskScore: calculateSecurityHealthScore(data.kpis)
                        }
                    });
                }

                // 2. Initial Hydration (Only if empty)
                if (state.vulnerabilities.length === 0) {
                    const vulnRes = await fetch('/vulnerabilities');
                    if (vulnRes.ok) {
                        const vulns = await vulnRes.json();
                        // Map standardized status
                        const formatted = vulns.map(v => ({
                            ...v,
                            status: v.status === 'Fixed' ? STAGES.CLOSED : STAGES.DETECTED
                        }));

                        PipelineStore.update({
                            vulnerabilities: formatted,
                            systemMetrics: {
                                ...state.systemMetrics,
                                totalVulnerabilities: formatted.length,
                                pending: formatted.filter(v => v.status !== STAGES.CLOSED).length
                            }
                        });
                    }
                }

                // 3. Tab Specific Refreshes
                const active = state.activeTabId;
                if (active === 'reports') await syncComplianceReports();

                // Keep engine/network polling for now
                if (active === 'network') await syncInfrastructureMonitor();

                document.getElementById('conn-lost').classList.add('hidden');
                document.getElementById('retry-badge').classList.add('hidden');
                failCount = 0;
            } catch (err) {
                console.error("DATA_ENGINE_ERROR:", err);
                // Fail silently for now to avoid alert spam
            }
        }

        async function triggerScan() {
            try {
                sendHUDToast("INITIALIZING_DIAGNOSTIC_KERNEL...", "info");

                const res = await fetch('/scan-trigger', { method: 'POST' });
                if (!res.ok) throw new Error("Scan Init Failed");

                const result = await res.json(); // { scan_id, status }

                // Simulate Scan Duration
                setTimeout(async () => {
                    const vulnRes = await fetch('/vulnerabilities');
                    const vulns = await vulnRes.json();

                    const newVulns = vulns.map(v => ({ ...v, status: STAGES.DETECTED }));

                    PipelineStore.update({
                        scanId: result.scan_id,
                        vulnerabilities: newVulns,
                        activeTabId: 'vulnerabilities', // Auto-Nav Step
                        systemMetrics: {
                            ...PipelineStore.state.systemMetrics,
                            totalScans: PipelineStore.state.systemMetrics.totalScans + 1,
                            totalVulnerabilities: newVulns.length,
                            pending: newVulns.length
                        }
                    });

                    await logLifecycleEvent('SCAN_COMPLETED', result.scan_id, `Full diagnostic completed. Found ${newVulns.length} threats.`);

                    switchTab('vulnerabilities'); // Visual switch
                    sendHUDToast("SCAN_COMPLETE: THREATS_ISOLATED", "success");

                }, 2000);

            } catch (e) {
                console.error(e);
                sendHUDToast("SCAN_FAILED: KERNEL_ERROR", "error");
            }
        }

        function updateSystemMarquee() {
            const marquee = document.getElementById('footer-marquee');
            const state = PipelineStore.state;
            const vulns = state.vulnerabilities;
            const active = vulns.filter(v => v.status !== STAGES.CLOSED).length;
            const resolved = vulns.filter(v => v.status === STAGES.CLOSED).length;
            const lastEvent = state.lifecycleLog.length > 0 ? state.lifecycleLog[state.lifecycleLog.length - 1].action : 'SYSTEM_READY';

            marquee.innerHTML = `
                [CORE_STATUS: STABLE] - 
                [ACTIVE_THREATS: ${active}] - 
                [AI_HEALED: ${resolved}] - 
                [LATEST_EVENT: ${lastEvent}] - 
                [DB_PERSISTENCE: ENGAGED] - 
                [AI_LINK: ACTIVE]
            `;
        }

        function renderDashboardMetrics() {
            const state = PipelineStore.state;
            const vulns = state.vulnerabilities;
            const activeCount = vulns.filter(v => v.status !== STAGES.CLOSED).length;
            const healedCount = vulns.filter(v => v.status === STAGES.CLOSED).length;
            const total = vulns.length || 0;

            // Use calculated risk or system metric
            const healthScore = state.systemMetrics.riskScore || 100;

            document.getElementById('dash-health').innerText = healthScore;
            document.getElementById('dash-total').innerText = total;
            document.getElementById('dash-active').innerText = activeCount;
            document.getElementById('dash-healed').innerText = healedCount;
            document.getElementById('dash-mttr').innerText = '14s'; // Static metric for now
            updateHealthCircle(healthScore);

            const dist = { "CRITICAL": 0, "HIGH": 0, "MEDIUM": 0, "LOW": 0 };
            vulns.forEach(v => {
                const s = v.severity.toUpperCase();
                if (s.includes('CRITICAL')) dist.CRITICAL++;
                else if (s.includes('HIGH')) dist.HIGH++;
                else if (s.includes('MEDIUM')) dist.MEDIUM++;
                else dist.LOW++;
            });

            const distHtml = Object.entries(dist).map(([sev, count]) => `
                <div class="flex-1">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-[8px] font-bold text-zinc-500 uppercase tracking-widest">${sev}</span>
                        <span class="text-[10px] font-bold text-white">${count}</span>
                    </div>
                    <div class="w-full h-1 bg-zinc-800 rounded-full overflow-hidden">
                        <div class="h-full ${sev.includes('CRITICAL') ? 'bg-red-500' : (sev.includes('HIGH') ? 'bg-orange-500' : 'bg-blue-500')}" 
                             style="width: ${(total > 0 ? (count / total * 100) : 0)}%"></div>
                    </div>
                </div>
            `).join('');
            document.getElementById('risk-distribution-hud').innerHTML = distHtml;

            if (window.mainStatsChart) {
                // Simulate live data movement
                mainStatsChart.data.datasets[0].data = mainStatsChart.data.datasets[0].data.map(v => Math.max(0, v + (Math.random() - 0.5) * 5));
                mainStatsChart.update();
            }
        }

        function calculateSecurityHealthScore(kpis) {
            if (!kpis.total) return 100;
            const unresolvedWeight = (kpis.active / kpis.total) * 100;
            return Math.max(0, Math.min(100, 100 - unresolvedWeight)).toFixed(0);
        }

        function updateHealthCircle(score) {
            const ring = document.getElementById('health-ring');
            const circumference = 390; // 2 * PI * 62
            const offset = circumference - (score / 100) * circumference;
            ring.style.strokeDashoffset = offset;
        }

        // --- SUB-DATA HYDRATION ---
        // --- SUB-DATA HYDRATION ---
        function renderVulnerabilityBank() {
            const data = PipelineStore.state.vulnerabilities;
            const body = document.getElementById('vuln-table-body');

            if (data.length === 0) {
                body.innerHTML = `<tr><td colspan="5" class="py-20 text-center text-zinc-600 font-mono text-[10px]">AWAITING_DIAGNOSTIC_SCAN...</td></tr>`;
                return;
            }

            body.innerHTML = data.map(v => `
                <tr onclick="selectVulnerability('${v.id}')" class="group hover:bg-blue-500/5 transition duration-300 cursor-pointer ${PipelineStore.state.activeVulnerability?.id === v.id ? 'bg-blue-500/10' : ''}">
                    <td class="px-8 py-5">
                        <div class="text-white font-bold uppercase tracking-tight">${v.vulnerability_type}</div>
                        <div class="text-[8px] text-zinc-600 mt-1 uppercase font-bold tracking-widest">${v.id.substring(0, 8)}...</div>
                    </td>
                    <td class="px-8 py-5 font-mono font-medium text-zinc-500">
                         ${v.file_path.split(/[\\/]/).pop()} <span class="text-zinc-700 text-[10px] ml-2 font-bold">@L:${v.vulnerable_lines}</span>
                    </td>
                    <td class="px-8 py-5 text-center">
                         <span class="px-3 py-1 rounded-md text-[9px] font-bold uppercase tracking-widest border border-current/20 ${v.severity.includes('CRITICAL') || v.severity.includes('HIGH') ? 'text-red-500 bg-red-500/10' : 'text-blue-500 bg-blue-500/10'}">${v.severity}</span>
                    </td>
                    <td class="px-8 py-5 text-center">
                        <span class="text-[9px] font-bold uppercase tracking-widest ${v.status === STAGES.VALIDATED || v.status === STAGES.CLOSED ? 'text-emerald-400' : (v.status === STAGES.FIX_GENERATED ? 'text-amber-400' : 'text-zinc-500')}">${v.status}</span>
                    </td>
                    <td class="px-8 py-5 flex justify-end">
                         <button class="flex items-center gap-2 text-[9px] font-bold uppercase text-zinc-500 group-hover:text-blue-400 transition">
                            Investigate <i data-lucide="arrow-right" class="w-3 h-3"></i>
                         </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function selectVulnerability(id) {
            const vuln = PipelineStore.state.vulnerabilities.find(v => v.id === id);
            if (!vuln) return;
            PipelineStore.update({ activeVulnerability: vuln });
            inspectVulnerability(id);
        }

        async function inspectVulnerability(id) {
            // Auto-Navigate to Lab as per Step 4
            switchTab('patch-lab');

            // Fetch detailed context
            const res = await fetch(`/vulnerabilities/${id}/source`);
            const details = await res.json();

            // Merge details into active vuln in state
            const currentActive = PipelineStore.state.activeVulnerability;
            PipelineStore.update({
                activeVulnerability: { ...currentActive, ...details }
            });

            const active = PipelineStore.state.activeVulnerability;

            // Update UI Bindings
            document.getElementById('editor-filename').innerText = active.file || active.file_path;

            // If status is still DETECTED, we show option to generate fix
            if (active.status === STAGES.DETECTED) {
                await generateAIFix(id); // Auto-trigger for "Seamless" feel or could be manual
            } else {
                renderEditorContent(); // Render existing patches
            }

            renderRiskAssessment();
            updateLogicUI();
        }

        async function generateAIFix(id) {
            if (PipelineStore.state.activeVulnerability.status !== STAGES.DETECTED) return;

            sendHUDToast("AI_ENGINE: Synthesizing neural patch...", "info");

            // Simulate AI Gen Delay
            setTimeout(async () => {
                const newStatus = STAGES.FIX_GENERATED;

                // Update State
                const updatedVulns = PipelineStore.state.vulnerabilities.map(v =>
                    v.id === id ? { ...v, status: newStatus } : v
                );

                PipelineStore.update({
                    vulnerabilities: updatedVulns,
                    activeVulnerability: { ...PipelineStore.state.activeVulnerability, status: newStatus }
                });

                await logLifecycleEvent('PATCH_GENERATED', id, 'Neural network synthesized a remediation candidate.');
                sendHUDToast("AI_FIX: Candidate generated.", "success");

                renderEditorContent();
                updateLogicUI();
                renderRiskAssessment();

            }, 1500);
        }

        function renderPatchLaboratory() {
            const list = document.getElementById('lab-vuln-list');
            const data = PipelineStore.state.vulnerabilities;
            const activeId = PipelineStore.state.activeVulnerability?.id;

            if (data.length === 0) {
                list.innerHTML = `<div class="p-10 text-center text-zinc-700 font-mono text-[9px]">NO_ACTIVE_CASES</div>`;
                return;
            }

            list.innerHTML = data.map(v => `
                <div onclick="selectVulnerability('${v.id}')" class="p-5 enterprise-card cursor-pointer transition-all border-l-4 ${activeId === v.id ? 'border-l-blue-500 bg-blue-500/5' : 'border-l-transparent hover:border-l-white/20'}">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-[8px] font-bold ${v.status === STAGES.VALIDATED ? 'text-emerald-500' : 'text-zinc-500'} uppercase tracking-widest">${v.status}</span>
                        <div class="w-1.5 h-1.5 rounded-full ${v.severity.includes('CRITICAL') ? 'bg-red-500' : 'bg-blue-500'}"></div>
                    </div>
                    <h5 class="text-white font-bold text-[10px] uppercase truncate">${v.vulnerability_type}</h5>
                    <p class="text-[9px] text-zinc-600 mt-1 font-mono truncate">${v.file_path}</p>
                </div>
            `).join('');
        }

        async function validateNeuralPatch() {
            const active = PipelineStore.state.activeVulnerability;
            if (!active) return;
            const id = active.id;

            sendHUDToast("VALIDATING: Executing AI integrity checks...", "info");

            // Mock Validation Call
            setTimeout(async () => {
                const newStatus = STAGES.VALIDATED;

                // Update Global State
                const updatedVulns = PipelineStore.state.vulnerabilities.map(v =>
                    v.id === id ? { ...v, status: newStatus } : v
                );

                PipelineStore.update({
                    vulnerabilities: updatedVulns,
                    activeVulnerability: { ...active, status: newStatus },
                    systemMetrics: {
                        ...PipelineStore.state.systemMetrics,
                        autoFixed: PipelineStore.state.systemMetrics.autoFixed + 1,
                        pending: PipelineStore.state.systemMetrics.pending - 1
                    }
                });

                await logLifecycleEvent('VALIDATED', id, `Patch integrity verified. Risk mitigated.`);
                sendHUDToast("VALIDATION_SUCCESS: Patch Verified.", "success");

                // Auto-Nav to Risk Assessment as per Step 5 -> 6 transition
                switchTab('risk');

            }, 1500);
        }

        let currentViewMode = 'original';
        function setViewMode(mode) {
            currentViewMode = mode;
            // Update buttons
            const btnOrig = document.getElementById('view-mode-original');
            const btnFix = document.getElementById('view-mode-fixed');
            if (mode === 'original') {
                btnOrig?.classList.remove('text-zinc-600'); btnOrig?.classList.add('bg-zinc-800', 'text-white');
                btnFix?.classList.add('text-zinc-600'); btnFix?.classList.remove('bg-zinc-800', 'text-white');
            } else {
                btnFix?.classList.remove('text-zinc-600'); btnFix?.classList.add('bg-zinc-800', 'text-white');
                btnOrig?.classList.add('text-zinc-600'); btnOrig?.classList.remove('bg-zinc-800', 'text-white');
            }
            renderEditorContent();
        }

        function renderDecisionTree() {
            const data = PipelineStore.state.activeVulnerability || { status: 'DETECTED', vulnerability_type: 'Unknown', file_path: 'No selection', severity: 'LOW' };
            const container = document.getElementById('logic-steps-flow'); // Ensure we target the flow container, not just terminal

            // 1. Update Lifecycle Flow Visualization
            const flowSteps = ['step-detection', 'step-recognition', 'step-selection', 'step-approval', 'step-closed'];
            const statusMap = {
                [STAGES.DETECTED]: 0,
                [STAGES.FIX_GENERATED]: 1, // 'Detected' -> 'Fix Generated'
                [STAGES.VALIDATED]: 2,
                [STAGES.APPROVED]: 3,
                [STAGES.CLOSED]: 4
            };
            const currentStep = statusMap[data.status] || 0;

            flowSteps.forEach((id, idx) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (idx <= currentStep) {
                    el.classList.remove('opacity-30');
                    el.classList.add('opacity-100');
                    el.querySelector('.w-12').classList.remove('border-zinc-800');
                    el.querySelector('.w-12').classList.add('border-blue-500', 'bg-blue-500/10');
                    el.querySelector('i').classList.remove('text-zinc-600');
                    el.querySelector('i').classList.add('text-blue-500');
                } else {
                    el.classList.add('opacity-30');
                    el.classList.remove('opacity-100');
                    el.querySelector('.w-12').classList.add('border-zinc-800');
                    el.querySelector('.w-12').classList.remove('border-blue-500', 'bg-blue-500/10');
                    el.querySelector('i').classList.add('text-zinc-600');
                    el.querySelector('i').classList.remove('text-blue-500');
                }
            });

            // 2. Update Reasoning Terminal
            const terminal = document.getElementById('logic-reasoning-terminal');
            if (terminal) {
                terminal.innerHTML = `
                    <div class="mb-4 text-emerald-500 font-mono text-[10px]">&gt; INITIALIZING_REASONING_ENGINE...</div>
                    <div class="mb-2 text-zinc-400 font-mono text-[10px] flex gap-4">
                        <span class="text-zinc-700 underline">OBJECTIVE</span>
                        <span>Remediate ${data.vulnerability_type} in ${data.file_path ? data.file_path.split(/[\\/]/).pop() : '...'}</span>
                    </div>
                    <div class="mb-2 text-blue-400 font-mono text-[10px]">&gt; Analyzing logic sinks...</div>
                    <div class="mb-4 text-zinc-500 font-mono text-[10px] p-4 bg-zinc-950/50 rounded-lg border border-white/5">
                        // AI ANALITICAL TRACE<br>
                        PATTERN_RECOGNITION: ${data.severity}_VULN<br>
                        FIX_STRATEGY: NEURAL_SYNTHESIS<br>
                        CURRENT_STATUS: ${data.status}
                    </div>
                    <div class="text-zinc-600 font-mono text-[9px] animate-pulse">_ EXECUTION_STATE: ${data.status}</div>
                `;
            }
        }

        // Alias for compatibility if needed or rename in renderApp
        const updateLogicUI = renderDecisionTree;

        function renderRiskAssessment() {
            const data = PipelineStore.state.activeVulnerability;
            if (!data) return;

            // Formula: Risk = severityWeight * (100 - confidenceScore)
            const sevWeights = { 'CRITICAL': 1.0, 'HIGH': 0.8, 'MEDIUM': 0.5, 'LOW': 0.2 };
            const sevWeight = sevWeights[data.severity] || 0.5;
            const confidence = data.confidence || 85;

            // Calculate Risk (0-100 scale)
            const riskValue = (sevWeight * (100 - confidence)).toFixed(1);

            // Update UI
            const scoreEl = document.getElementById('risk-engine-score');
            const classificationEl = document.getElementById('risk-impact-classification');
            const gauge = document.getElementById('risk-gauge-circle');

            scoreEl.innerText = riskValue;

            // Gauge visualization (assuming 452 circumference)
            const offset = 452 - (452 * (Math.min(riskValue, 100) / 100));
            gauge.style.strokeDashoffset = offset;

            // Color coding
            const color = riskValue > 50 ? '#ef4444' : (riskValue > 20 ? '#f59e0b' : '#3b82f6');
            gauge.style.color = color;
            classificationEl.style.color = color;
            classificationEl.innerText = riskValue > 50 ? "CRITICAL_EXPOSURE" : (riskValue > 20 ? "ELEVATED_RISK" : "NOMINAL_RISK");

            // Vector Bars
            document.getElementById('risk-v-sev').innerText = data.severity;
            document.getElementById('risk-b-sev').style.width = (sevWeight * 100) + '%';
            // Placeholder/Simulated vectors if not in data
            document.getElementById('risk-v-expl').innerText = "0.8";
            document.getElementById('risk-b-expl').style.width = '80%';
        }

        function updateForensisView() {
            renderForensicDiff();
        }

        function renderForensicDiff() {
            const active = PipelineStore.state.activeVulnerability;
            if (!active || !active.content_original) return;

            const origDiv = document.getElementById('forensic-editor-orig');
            const fixDiv = document.getElementById('forensic-editor-fixed');

            if (!origDiv || !fixDiv) return;

            origDiv.innerHTML = '';
            fixDiv.innerHTML = '';

            const origLines = active.content_original.split('\n');
            const fixLines = (active.content_fixed || active.content_original).split('\n'); // Fallback if no fix yet
            const vLines = (active.lines || '').split(',').map(n => parseInt(n.trim()));

            // Maximum length to iterate through both
            const max = Math.max(origLines.length, fixLines.length);

            for (let i = 0; i < max; i++) {
                const ln = i + 1;
                const oLine = origLines[i] || '';
                const fLine = fixLines[i] || '';

                const d1 = document.createElement('div');
                d1.className = 'px-4 min-h-[1.5em] border-l-2 border-transparent';
                d1.textContent = (i < origLines.length) ? oLine : '';

                const d2 = document.createElement('div');
                d2.className = 'px-4 min-h-[1.5em] border-l-2 border-transparent';
                d2.textContent = (i < fixLines.length) ? fLine : '';

                // Highlights if fix exists
                if (active.content_fixed && oLine !== fLine) {
                    d1.classList.add('bg-red-500/10', 'border-red-500', 'text-red-200', 'not-italic');
                    d2.classList.add('bg-emerald-500/10', 'border-emerald-500', 'text-emerald-200', 'not-italic');
                } else if (vLines.includes(ln)) {
                    d1.classList.add('bg-red-500/5', 'text-zinc-300');
                }

                origDiv.appendChild(d1);
                fixDiv.appendChild(d2);
            }
        }

        function renderEditorContent() {
            if (!selectedVulnObject) return;
            const editor = document.getElementById('editor-body');
            const nums = document.getElementById('editor-nums');
            const content = currentViewMode === 'original' ? selectedVulnObject.content_original : selectedVulnObject.content_fixed;

            editor.innerHTML = '';
            nums.innerHTML = '';

            const vLines = selectedVulnObject.lines.split(',').map(n => parseInt(n.trim()));

            content.split('\n').forEach((line, i) => {
                const ln = i + 1;
                const div = document.createElement('div');
                div.className = 'px-6 transition hover:bg-white/5 whitespace-pre min-h-[1.5em]';

                if (currentViewMode === 'fixed') {
                    // Check if this line was changed (very simple diff heuristic for demo)
                    const originalLines = selectedVulnObject.content_original.split('\n');
                    if (line !== originalLines[i]) {
                        div.classList.add('bg-emerald-500/10', 'border-l-[4px]', 'border-emerald-500', 'text-emerald-400', 'not-italic');
                        div.textContent = line + ' # [PATCH_APPLIED]';
                    } else {
                        div.textContent = line || ' ';
                    }
                } else {
                    div.textContent = line || ' ';
                    if (vLines.includes(ln)) {
                        div.classList.add('bg-red-500/10', 'border-l-[4px]', 'border-red-500', 'text-white', 'not-italic');
                        div.innerHTML = `<span class="relative">${div.textContent.trim()}<span class="absolute -left-20 top-0.5 bg-red-600 text-white px-2 py-0.5 rounded font-black text-[8px] animate-pulse">BREAK</span></span>`;
                    }
                }

                editor.appendChild(div);
                const n = document.createElement('div');
                n.textContent = ln;
                nums.appendChild(n);
            });
        }

        function showStudioAlert(msg) {
            const box = document.getElementById('code-alert-box');
            document.getElementById('alert-text-body').innerText = msg;
            box.classList.remove('hidden');
            box.classList.add('flex');
            setTimeout(() => box.classList.remove('translate-y-10'), 100);
        }

        async function renderComplianceLedger() {
            const data = PipelineStore.state.lifecycleLog;
            const body = document.getElementById('audit-ledger-body');
            if (data.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="px-8 py-20 text-center italic text-zinc-600 font-mono tracking-widest">AWAITING_TELEMETRY_STREAM...</td></tr>';
                return;
            }
            body.innerHTML = data.map((l, idx) => { // Added idx for ID gen
                const actionColor = l.action.includes('VALIDATED') ? 'text-emerald-400' : (
                    l.action.includes('SCAN') ? 'text-blue-400' : (
                        l.action.includes('DETECT') ? 'text-red-400' : 'text-zinc-500'
                    ));

                return `
                    <tr class="hover:bg-blue-500/5 transition group">
                        <td class="px-8 py-6">
                            <div class="text-[10px] text-zinc-300 font-bold">${new Date(l.timestamp).toLocaleString()}</div>
                            <div class="text-[8px] text-zinc-600 font-mono mt-1">#AUDIT-${String(idx + 1).padStart(4, '0')}</div>
                        </td>
                        <td class="px-8 py-6">
                            <span class="px-3 py-1 bg-zinc-900 border border-white/5 rounded-lg text-[9px] font-black uppercase tracking-widest ${actionColor}">${l.action}</span>
                        </td>
                        <td class="px-8 py-6">
                            <div class="text-zinc-400 text-[11px] font-bold">${l.description || 'System Log Event'}</div>
                            ${l.vulnerabilityId ? `<div class="text-[8px] text-zinc-700 mt-1 uppercase font-black tracking-widest italic">REF: ${l.vulnerabilityId.substring(0, 8)}...</div>` : ''}
                        </td>
                        <td class="px-8 py-6">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full ${l.actor === 'SYSTEM_KERNEL' ? 'bg-blue-500' : 'bg-amber-500'}"></div>
                                <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">${l.actor}</span>
                            </div>
                        </td>
                        <td class="px-8 py-6 text-right">
                            <span class="text-[8px] font-mono text-zinc-700 break-all">${l.integrityHash.substring(0, 32)}...</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function renderAuditStream() {
            const data = [...PipelineStore.state.lifecycleLog].reverse().slice(0, 10);
            const container = document.getElementById('audit-ticker');
            if (!container) return;
            container.innerHTML = data.map(l => `
                <div class="flex items-center gap-4 py-3 border-b border-white/5 group hover:bg-white/5 px-4 transition-all">
                    <span class="text-zinc-700 font-mono text-[8px]">${new Date(l.timestamp).toLocaleTimeString()}</span>
                     <span class="text-[9px] font-black uppercase tracking-tighter ${l.action.includes('VALIDATED') ? 'text-emerald-500' : 'text-blue-500'}">${l.action}</span>
                     <span class="text-zinc-400 text-[10px] font-medium truncate flex-1">${l.description}</span>
                </div>
            `).join('');
        }

        function exportComplianceCSV() {
            const table = document.querySelector('#tab-audit table');
            let csv = [];
            const rows = table.querySelectorAll('tr');
            for (const row of rows) {
                const cols = row.querySelectorAll('td, th');
                const rowData = [];
                for (const col of cols) rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
                csv.push(rowData.join(','));
            }
            const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
            const downloadLink = document.createElement('a');
            downloadLink.download = `compliance_ledger_${new Date().getTime()}.csv`;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            sendHUDToast("GOVERNANCE: Compliance CSV exported.", "success");
        }

        async function syncComplianceReports() {
            const res = await fetch('/reports');
            const data = await res.json();
            const grid = document.getElementById('reports-grid');
            grid.innerHTML = data.map(r => `
                <div class="p-8 enterprise-card group hover:bg-blue-500/5 transition duration-500">
                    <div class="flex justify-between items-start mb-10">
                        <div class="w-12 h-12 rounded-xl bg-zinc-950 flex items-center justify-center border border-white/5">
                            <i data-lucide="file-check" class="text-blue-500 w-5 h-5"></i>
                        </div>
                        <span class="text-[9px] font-bold text-blue-500 uppercase tracking-widest">${r.status}</span>
                    </div>
                    <h5 class="text-white font-bold text-sm uppercase tracking-tight mb-4">${r.name}</h5>
                    <div class="flex justify-between items-end text-[10px] font-mono text-zinc-600 font-bold">
                        <span>ID: ${r.id}</span>
                        <span>${r.size} | ${r.date}</span>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function syncInfrastructureMonitor() {
            try {
                const statsRes = await fetch('/infrastructure/stats');
                let stats = statsRes.ok ? await statsRes.json() : DUMMY_DATA.infra.stats;

                document.getElementById('infra-posture-score').innerText = stats.average_posture + '%';
                document.getElementById('infra-avg-coverage').innerText = stats.average_coverage + '%';
                document.getElementById('infra-coverage-bar').style.width = stats.average_coverage + '%';
                document.getElementById('infra-total-assets').innerText = stats.total_assets;
                document.getElementById('infra-env-prod').innerText = stats.environment_breakdown.Production || 0;
                document.getElementById('infra-env-stag').innerText = stats.environment_breakdown.Staging || 0;
                document.getElementById('infra-env-dev').innerText = stats.environment_breakdown.Development || 0;

                const ring = document.getElementById('infra-posture-ring');
                const offset = 452 - (452 * (stats.average_posture / 100)); // Fixed circumference to match gauge
                ring.style.strokeDashoffset = offset;

                const assetsRes = await fetch('/infrastructure/assets');
                let assets = assetsRes.ok ? await assetsRes.json() : DUMMY_DATA.infra.assets;
                const grid = document.getElementById('infra-asset-grid');

                grid.innerHTML = assets.map(a => `
                    <div class="p-8 enterprise-card hover:bg-white/5 transition group">
                        <div class="flex justify-between items-start mb-10">
                            <div class="w-12 h-12 rounded-xl bg-zinc-950 flex items-center justify-center border border-white/5 group-hover:bg-blue-500/10 transition duration-500">
                                <i data-lucide="${a.type === 'Service' ? 'cpu' : (a.type === 'Application' ? 'layout' : 'github')}" class="text-blue-500 w-5 h-5"></i>
                            </div>
                            <span class="px-3 py-1 bg-zinc-950 border border-white/5 rounded-lg text-[8px] font-bold uppercase tracking-widest text-zinc-500">${a.environment}</span>
                        </div>
                        <h5 class="text-white font-bold text-sm uppercase tracking-tight mb-2 truncate">${a.name}</h5>
                        <p class="text-zinc-600 text-[10px] font-medium leading-relaxed line-clamp-2 h-10 mb-8">${a.description || 'Securing critical endpoint node.'}</p>
                        <div class="space-y-6">
                            <div class="space-y-2">
                                <div class="flex justify-between text-[9px] font-bold uppercase tracking-widest">
                                    <span class="text-zinc-500">Coverage</span>
                                    <span class="text-white">${a.coverage}%</span>
                                </div>
                                <div class="w-full h-1 bg-zinc-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500" style="width: ${a.coverage}%"></div>
                                </div>
                            </div>
                            <div class="flex justify-between items-end">
                                <div><span class="text-[9px] font-bold text-zinc-700 uppercase block mb-1">Critical</span><span class="text-xl font-extrabold ${a.critical_vulnerabilities > 0 ? 'text-red-500' : 'text-zinc-500'}">${a.critical_vulnerabilities}</span></div>
                                <div class="text-right"><span class="text-[9px] font-bold text-zinc-700 uppercase block mb-1">Posture</span><span class="text-xl font-extrabold text-emerald-500">${a.posture_score}%</span></div>
                            </div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            } catch (e) { console.error("Infra Monitor Sync Fail", e); }
        }

        function renderSystemCoreUI(health, scans) {
            document.getElementById('health-ai-status').innerText = health.ai_engine.status;
            document.getElementById('health-scanner-status').innerText = health.scanner.status;
            document.getElementById('health-queue-total').innerText = health.processing_queues.total_pending;
            document.getElementById('health-uptime').innerText = health.uptime;

            const body = document.getElementById('scan-history-body');
            if (scans.length === 0) {
                body.innerHTML = '<tr><td colspan="4" class="px-8 py-20 text-center italic text-zinc-600">Awaiting diagnostic initialization...</td></tr>';
                return;
            }
            body.innerHTML = scans.map(s => `
                <tr class="hover:bg-white/5 transition group">
                    <td class="px-8 py-6">
                        <div class="font-mono text-white text-[10px] mb-1">#${s.id.split('-')[0]}</div>
                        <div class="text-[9px] text-zinc-600 font-bold uppercase">${new Date(s.timestamp).toLocaleString()}</div>
                    </td>
                    <td class="px-8 py-6"><div class="flex items-center gap-3"><i data-lucide="folder" class="w-3 h-3 text-sky-500/50"></i><span class="text-zinc-300 font-bold">${s.target}</span></div></td>
                    <td class="px-8 py-6 text-center"><span class="px-3 py-1 bg-sky-500/10 text-sky-500 rounded-full text-[9px] font-black uppercase tracking-widest">${s.status}</span></td>
                    <td class="px-8 py-6 text-right"><div class="font-black text-white text-lg">${s.findings}</div></td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        // Local Audit Stream is now handled reactive via ScanSession lifecycleLog
        function syncAuditStream() {
            renderAuditStream();
        }

        async function triggerScan() {
            if (scanInProgress) return;
            const target = document.getElementById('scan-target').value || '.';
            const btn = document.getElementById('btn-run-scan');

            scanInProgress = true;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> DIAGNOSING...`;
            lucide.createIcons();

            try {
                sendHUDToast("CORE_SIGNAL: Initializing diagnostic logic...", "info");
                const res = await fetch('/scan-trigger?path=' + encodeURIComponent(target), {
                    method: 'POST'
                });
                const result = await res.json();

                if (result.status === 'success') {
                    // Step 1: Populate scanSession.vulnerabilities[]
                    const vulnRes = await fetch('/vulnerabilities');
                    const vulns = await vulnRes.json();

                    updateState({
                        vulnerabilities: vulns,
                        id: result.scan_id || Date.now()
                    });

                    addLifecycleEvent('SCAN_COMPLETE', result.scan_id, `Identified ${result.findings} anomalies in ${target}`);

                    sendHUDToast(`DIAGNOSTIC_COMPLETE: Identified ${result.findings} anomalies.`, "success");

                    // Step 1: Automatically navigate to "Vulnerability Bank"
                    switchTab('vulnerabilities');
                } else {
                    sendHUDToast(`DIAGNOSTIC_ERROR: ${result.message}`, "error");
                }
            } catch (e) {
                sendHUDToast("CORE_FATAL: Link severed during scan.", "error");
            } finally {
                scanInProgress = false;
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="zap" class="w-4 h-4"></i> Launch Diagnostic`;
                lucide.createIcons();
            }
        }

        function updateForensicDetails() {
            if (selectedVulnObject) {
                document.getElementById('forensic-raw-data').innerText = JSON.stringify(selectedVulnObject, null, 4);
            }
        }

        // --- CORE SYSTEM ACTIONS ---
        // Deprecated: Global diagnostic redirected to Scanner Control Center
        async function runGlobalDiagnostic() {
            switchTab('engine');
            sendHUDToast("REDIRECTION: Accessing Scanner Command Center.", "info");
        }

        async function approveNeuralPatch() {
            if (!selectedVulnObject) return;
            sendHUDToast("DEPLOYING_REMEDIATION: Patching secure kernel...", "info");
            const res = await fetch(`/review/${selectedVulnObject.id}?action=approve`, { method: 'POST' });
            if (res.ok) {
                sendHUDToast("INTEGRITY_RESTORED: Source code successfully fixed.", "success");
                await syncAllData(); // Immediate sync
            }
        }

        async function rejectNeuralPatch() {
            if (!selectedVulnObject) return;
            const res = await fetch(`/review/${selectedVulnObject.id}?action=reject`, { method: 'POST' });
            if (res.ok) {
                sendHUDToast("ANOMALY_BYPASSED: Logic chain recalibrated.", "info");
                await syncAllData(); // Immediate sync
            }
        }

        // --- FAIL-SAFE HANDLERS ---
        function handleDataFailure() {
            failCount++;
            document.getElementById('retry-badge').classList.remove('hidden');
            if (failCount > 3) {
                document.getElementById('conn-lost').classList.remove('hidden');
            }
        }

        function startMainHeartbeat() {
            syncAllData();
            setInterval(syncAllData, 5000); // 5s REAL-TIME EXECUTIVE CYCLE
        }

        function sendHUDToast(msg, type) {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `p-5 bg-zinc-900 rounded-xl border-l-[4px] ${type == 'success' ? 'border-emerald-500' : (type == 'error' ? 'border-red-500' : 'border-blue-500')} shadow-2xl animate-hud-toast pointer-events-auto border border-white/5`;
            t.innerHTML = `
                <div class="flex items-center gap-4">
                     <div class="w-8 h-8 rounded-lg bg-zinc-950 flex items-center justify-center border border-white/5">
                        <i data-lucide="${type == 'success' ? 'shield-check' : (type == 'error' ? 'alert-octagon' : 'blue-shield')}" class="w-4 h-4 ${type == 'success' ? 'text-emerald-500' : (type == 'error' ? 'text-red-500' : 'text-blue-500')}"></i>
                     </div>
                     <div>
                        <p class="text-[9px] font-bold uppercase tracking-widest text-zinc-600 mb-0.5">System Notification</p>
                        <p class="text-[11px] font-bold text-white tracking-tight uppercase">${msg}</p>
                     </div>
                </div>
            `;
            container.appendChild(t);
            lucide.createIcons();
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translateY(-20px) scale(0.95)';
                setTimeout(() => t.remove(), 500);
            }, 5000);
        }
    </script>
    <style>
        @keyframes hud-toast {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-hud-toast {
            animation: hud-toast 0.4s ease-out;
        }

        .animate-marquee {
            animation: marquee 50s linear infinite;
        }

        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }
    </style>
</body>

</html>